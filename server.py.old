from flask import Flask
import json
from updater import Updater
import sqlite3

conn = sqlite3.connect('departures.db')

app = Flask(__name__)

modes = {
    "000": 0,
    "001": 1,
    "010": 2,
    "011": 3,
    "100": 4,
    "101": 5,
    "110": 6,
    "111": 7,
}

stations = {
    "60500014": 0,
    "60500296": 0,
    "60500015": 1,
    "60500470": 2,
    "60500450": 3,
    "60500460": 4,
    "60500313": 5,
    "60500314": 6,
    "60502380": 6,
    "60500315": 7,
    "60501480": 7,
    "60500410": 8,
    "60500321": 9,
    "60501810": 10,
    "60501590": 11,
    "60501520": 11,
    "60501310": 12,
    "60501150": 13,
    "60501110": 14,
    "60501210": 15,
    "60501040": 15,
    "60501140": 16,
    "60501070": 17,
    "60501500": 18,
    "60501200": 19,
    "60501000": 20,
    "60500950": 20,
    "60501170": 21,
    "60501660": 22,
    "60501750": 23,
    "60500120": 24,
    "60500090": 25,
    "60500046": 25,
    "60500081": 25,
    "60500080": 26,
    "60500150": 27,
    "60501720": 28,
    "60500990": 29,
    "60500940": 30,
    "60501060": 31,
    "60501160": 32,
    "60501010": 33,
    "60501700": 34,
    "60501730": 35,
    "60501710": 36,
    "60501100": 37,
    "60501190": 38,
    "60501090": 39,
    "60501050": 40,
    "60501080": 41,
    "60501030": 42,
    "60501020": 42,
    "60500980": 43,
    "60500346": 44,
    "60501130": 45,
    "60500970": 46,
    "60500960": 47,
    "60501120": 48,
    "60500920": 49
}

def sumStates(a, b):
    c = ""
    for i in [0, 1, 2]:
        c += str(int(a[i]) or int(b[i]))
    return c

@app.route("/")
def hello():
    c = conn.cursor()
    data = ["000"]*50
    for (sid, state) in c.execute("SELECT id, state FROM stations"):
        data[int(stations[sid])] = sumStates(state, data[int(stations[sid])])
    output = ""
    for c in data:
        output += c
    return output

if __name__ == "__main__":
    app.run(host='0.0.0.0')
